#!/usr/bin/env node
// Build comprehensive code descriptions from all sources
const fs = require('fs');
const path = require('path');

const descriptions = {};

// Source 1: top-procedures.json
try {
  const top = JSON.parse(fs.readFileSync(path.join(__dirname, '..', 'public', 'data', 'top-procedures.json'), 'utf-8'));
  for (const p of top) {
    if (p.code && p.description) descriptions[p.code] = p.description;
  }
  console.log('From top-procedures:', Object.keys(descriptions).length);
} catch (e) { console.error('top-procedures:', e.message); }

// Source 2: Parse HCPCS_CODES.md
try {
  const md = fs.readFileSync(path.join(__dirname, '..', 'reference-data', 'HCPCS_CODES.md'), 'utf-8');
  const lines = md.split('\n');
  for (const line of lines) {
    const match = line.match(/^\|\s*([A-Z0-9]{4,5})\s*\|\s*(.+?)\s*\|/);
    if (match) {
      const code = match[1].trim();
      let desc = match[2].trim();
      // Clean up description - take first sentence or up to first period
      if (desc.includes('.')) desc = desc.split('.')[0].trim();
      if (desc.length > 80) desc = desc.substring(0, 77) + '...';
      if (!descriptions[code]) descriptions[code] = desc;
    }
  }
  console.log('After HCPCS_CODES.md:', Object.keys(descriptions).length);
} catch (e) { console.error('HCPCS_CODES.md:', e.message); }

// Source 3: Existing hcpcsDescription in format.ts
try {
  const fmt = fs.readFileSync(path.join(__dirname, '..', 'src', 'lib', 'format.ts'), 'utf-8');
  const regex = /'([A-Z0-9]+)':\s*'([^']+)'/g;
  let m;
  while ((m = regex.exec(fmt)) !== null) {
    if (!descriptions[m[1]]) descriptions[m[1]] = m[2];
  }
  console.log('After format.ts:', Object.keys(descriptions).length);
} catch (e) { console.error('format.ts:', e.message); }

// Source 4: Common HCPCS/CPT codes from medical knowledge
const commonCodes = {
  // E&M Office Visits
  '99201': 'Office/outpatient visit, new patient, straightforward',
  '99202': 'Office/outpatient visit, new patient, low complexity',
  '99203': 'Office/outpatient visit, new patient, moderate complexity',
  '99204': 'Office/outpatient visit, new patient, mod-high complexity',
  '99205': 'Office/outpatient visit, new patient, high complexity',
  '99211': 'Office/outpatient visit, est. patient, minimal',
  '99212': 'Office/outpatient visit, est. patient, straightforward',
  '99215': 'Office/outpatient visit, est. patient, high complexity',
  // ER Visits
  '99281': 'Emergency department visit, self-limited/minor',
  '99282': 'Emergency department visit, low complexity',
  '99283': 'Emergency department visit, moderate complexity',
  '99284': 'Emergency department visit, high complexity',
  '99285': 'Emergency department visit, high/urgent complexity',
  // Hospital
  '99221': 'Initial hospital care, straightforward/low',
  '99222': 'Initial hospital care, moderate complexity',
  '99223': 'Initial hospital care, high complexity',
  '99231': 'Subsequent hospital care, stable',
  '99232': 'Subsequent hospital care, responding inadequately',
  '99233': 'Subsequent hospital care, unstable/significant complication',
  '99238': 'Hospital discharge day management, 30 min or less',
  '99239': 'Hospital discharge day management, more than 30 min',
  // Preventive
  '99381': 'Preventive visit, new patient, infant (<1 yr)',
  '99382': 'Preventive visit, new patient, early childhood (1-4 yr)',
  '99383': 'Preventive visit, new patient, late childhood (5-11 yr)',
  '99384': 'Preventive visit, new patient, adolescent (12-17 yr)',
  '99385': 'Preventive visit, new patient, 18-39 yr',
  '99386': 'Preventive visit, new patient, 40-64 yr',
  '99391': 'Preventive visit, est. patient, infant (<1 yr)',
  '99392': 'Preventive visit, est. patient, early childhood (1-4 yr)',
  '99393': 'Preventive visit, est. patient, late childhood (5-11 yr)',
  '99394': 'Preventive visit, est. patient, adolescent (12-17 yr)',
  '99395': 'Preventive visit, est. patient, 18-39 yr',
  '99396': 'Preventive visit, est. patient, 40-64 yr',
  // Consultation
  '99241': 'Office consultation, straightforward',
  '99242': 'Office consultation, low complexity',
  '99243': 'Office consultation, moderate complexity',
  '99244': 'Office consultation, mod-high complexity',
  '99245': 'Office consultation, high complexity',
  // Mental Health
  '90791': 'Psychiatric diagnostic evaluation',
  '90792': 'Psychiatric diagnostic evaluation with medical services',
  '90832': 'Psychotherapy, 30 minutes',
  '90833': 'Psychotherapy, 30 min, add-on to E/M',
  '90836': 'Psychotherapy, 45 min, add-on to E/M',
  '90838': 'Psychotherapy, 60 min, add-on to E/M',
  '90839': 'Psychotherapy for crisis, first 60 min',
  '90840': 'Psychotherapy for crisis, each additional 30 min',
  '90846': 'Family psychotherapy without patient, 50 min',
  '90847': 'Family psychotherapy with patient, 50 min',
  '90853': 'Group psychotherapy',
  '90862': 'Pharmacologic management',
  '90882': 'Environmental intervention',
  '90887': 'Interpretation/explanation of results',
  '90899': 'Unlisted psychiatric service/procedure',
  // Rehab/PT
  '97110': 'Therapeutic exercises',
  '97112': 'Neuromuscular reeducation',
  '97116': 'Gait training',
  '97140': 'Manual therapy techniques',
  '97150': 'Group therapeutic procedures',
  '97161': 'PT evaluation, low complexity',
  '97162': 'PT evaluation, moderate complexity',
  '97163': 'PT evaluation, high complexity',
  '97164': 'PT re-evaluation',
  '97165': 'OT evaluation, low complexity',
  '97166': 'OT evaluation, moderate complexity',
  '97167': 'OT evaluation, high complexity',
  '97168': 'OT re-evaluation',
  '97530': 'Therapeutic activities',
  '97535': 'Self-care/home management training',
  '97542': 'Wheelchair management training',
  '97010': 'Hot/cold packs application',
  '97012': 'Mechanical traction therapy',
  '97014': 'Electrical stimulation, unattended',
  '97018': 'Paraffin bath therapy',
  '97032': 'Electrical stimulation, manual',
  '97033': 'Iontophoresis',
  '97034': 'Contrast bath therapy',
  '97035': 'Ultrasound therapy',
  '97036': 'Hubbard tank therapy',
  // Lab
  '80048': 'Basic metabolic panel (BMP)',
  '80050': 'General health panel',
  '80053': 'Comprehensive metabolic panel (CMP)',
  '80061': 'Lipid panel',
  '80069': 'Renal function panel',
  '80076': 'Hepatic function panel',
  '80307': 'Drug test, presumptive (instrument)',
  '81001': 'Urinalysis, automated with microscopy',
  '81002': 'Urinalysis, non-automated without microscopy',
  '81003': 'Urinalysis, automated without microscopy',
  '85025': 'Complete blood count (CBC) with differential',
  '85027': 'Complete blood count (CBC)',
  '86580': 'Tuberculosis (TB) skin test',
  '86769': 'Antibody, SARS-CoV-2 (COVID-19)',
  '87491': 'Chlamydia detection, amplified probe',
  '87591': 'Neisseria gonorrhoeae detection',
  '87804': 'Influenza virus assay with direct optical',
  '87880': 'Strep A assay with direct optical',
  // Imaging
  '70553': 'MRI brain without/with contrast',
  '71046': 'Chest X-ray, 2 views',
  '71048': 'Chest X-ray, 4+ views',
  '72148': 'MRI lumbar spine without contrast',
  '73721': 'MRI joint of lower extremity',
  '74177': 'CT abdomen/pelvis with contrast',
  '76856': 'Pelvic ultrasound, complete',
  '76857': 'Pelvic ultrasound, limited',
  '93000': 'Electrocardiogram (ECG/EKG), complete',
  '93005': 'Electrocardiogram (ECG), tracing only',
  '93010': 'Electrocardiogram (ECG), interpretation only',
  '93306': 'Echocardiography, complete',
  // Vaccines
  '90460': 'Immunization admin, first vaccine, counseling',
  '90461': 'Immunization admin, additional vaccine, counseling',
  '90471': 'Immunization administration, first injection',
  '90472': 'Immunization administration, additional injection',
  '90473': 'Immunization admin, intranasal, first',
  '90651': 'HPV vaccine, 9-valent',
  '90696': 'DTaP-IPV vaccine',
  '90707': 'MMR vaccine',
  '90710': 'MMRV vaccine',
  '90713': 'Poliovirus vaccine (IPV)',
  '90714': 'Td vaccine',
  '90715': 'Tdap vaccine',
  '90723': 'DTaP-HepB-IPV vaccine',
  '90732': 'Pneumococcal vaccine (PPSV23)',
  '90746': 'Hepatitis B vaccine, adult',
  '90756': 'Influenza virus vaccine, quadrivalent',
  // COVID
  '91300': 'COVID-19 vaccine, Pfizer, first dose',
  '91301': 'COVID-19 vaccine, Moderna, first dose',
  '91302': 'COVID-19 vaccine, AstraZeneca',
  '91303': 'COVID-19 vaccine, J&J/Janssen',
  '0001A': 'COVID-19 vaccine admin, Pfizer, first dose',
  '0002A': 'COVID-19 vaccine admin, Pfizer, second dose',
  '0011A': 'COVID-19 vaccine admin, Moderna, first dose',
  '0012A': 'COVID-19 vaccine admin, Moderna, second dose',
  '0031A': 'COVID-19 vaccine admin, J&J, single dose',
  'U0003': 'Infectious disease detection (COVID-19)',
  'U0004': 'COVID-19 test, non-CDC lab',
  'U0005': 'Infectious disease detection, multiplex amplified probe',
  // Ambulance
  'A0425': 'Ambulance, ground mileage, per statute mile',
  'A0426': 'Ambulance, ALS non-emergency transport',
  'A0428': 'Ambulance, BLS non-emergency transport',
  'A0430': 'Ambulance, fixed wing air transport',
  'A0431': 'Ambulance, rotary wing air transport',
  // DME
  'A4253': 'Blood glucose test strips',
  'A4259': 'Lancets for blood glucose testing',
  'A6216': 'Gauze, non-impregnated, sterile',
  'E0260': 'Hospital bed, semi-electric',
  'E0601': 'CPAP device',
  'E1390': 'Oxygen concentrator',
  'K0001': 'Standard wheelchair',
  'K0823': 'Power wheelchair, Group 2',
  // Dental
  'D0120': 'Periodic oral evaluation',
  'D0140': 'Limited oral evaluation, problem focused',
  'D0150': 'Comprehensive oral evaluation',
  'D0210': 'Intraoral dental X-rays, complete series',
  'D0220': 'Intraoral periapical, first radiographic image',
  'D0230': 'Intraoral periapical, each additional image',
  'D0272': 'Bitewing X-rays, two radiographic images',
  'D0274': 'Bitewing X-rays, four radiographic images',
  'D1110': 'Prophylaxis (cleaning), adult',
  'D1120': 'Prophylaxis (cleaning), child',
  'D1206': 'Topical fluoride varnish',
  'D1351': 'Sealant, per tooth',
  'D2140': 'Amalgam filling, one surface',
  'D2150': 'Amalgam filling, two surfaces',
  'D2160': 'Amalgam filling, three surfaces',
  'D2330': 'Resin-based composite filling, one surface, anterior',
  'D2331': 'Resin-based composite filling, two surfaces, anterior',
  'D2391': 'Resin-based composite filling, one surface, posterior',
  'D2392': 'Resin-based composite filling, two surfaces, posterior',
  'D2750': 'Crown, porcelain fused to high noble metal',
  'D7140': 'Extraction, erupted tooth or exposed root',
  'D7210': 'Extraction, surgical, erupted tooth',
  'D7240': 'Extraction, impacted tooth, completely bony',
  // Behavioral/Waiver codes common in Medicaid
  'H0001': 'Alcohol and/or drug assessment',
  'H0002': 'Behavioral health screening',
  'H0004': 'Behavioral health counseling and therapy, per 15 min',
  'H0005': 'Alcohol/drug group counseling, per 15 min',
  'H0006': 'Alcohol/drug services, case management',
  'H0015': 'Alcohol/drug intensive outpatient, per hour',
  'H0020': 'Alcohol/drug services, methadone administration',
  'H0031': 'Mental health assessment',
  'H0032': 'Mental health service plan development',
  'H0034': 'Medication training and management, per 15 min',
  'H0035': 'Mental health partial hospitalization, per diem',
  'H0036': 'Community psychiatric supportive treatment, per 15 min',
  'H0037': 'Community psychiatric supportive treatment program, per diem',
  'H0038': 'Self-help/peer services, per 15 min',
  'H0039': 'Assertive community treatment, per 15 min',
  'H0040': 'Assertive community treatment program, per diem',
  'H0045': 'Respite care services, not in the home, per diem',
  'H0046': 'Mental health services, not otherwise specified',
  'H2010': 'Comprehensive medication services, per 15 min',
  'H2011': 'Crisis intervention service, per 15 min',
  'H2012': 'Behavioral health day treatment, per hour',
  'H2013': 'Psychiatric health facility service, per diem',
  'H2014': 'Skills training and development, per 15 min',
  'H2019': 'Therapeutic behavioral services, per 15 min',
  'H2021': 'Community-based wrap-around services, per 15 min',
  'H2023': 'Supported employment, per 15 min',
  'H2025': 'Supported services, waiver, per 15 min',
  'H2027': 'Psychoeducational services, per 15 min',
  // State/Waiver T-codes
  'T1001': 'Nursing assessment/evaluation',
  'T1002': 'RN services, up to 15 min',
  'T1003': 'LPN/LVN services, up to 15 min',
  'T1005': 'Respite care services, up to 15 min',
  'T1006': 'Alcohol/drug services, family/couple counseling',
  'T1007': 'Alcohol/drug services, treatment plan review',
  'T1012': 'Alcohol/drug services, skills development',
  'T1016': 'Case management, each 15 min',
  'T1023': 'Screening to determine appropriateness of services',
  'T1024': 'Evaluation and treatment by an integrated specialty team',
  'T1025': 'Intensive, specialized group, per diem',
  'T1028': 'Assessment of home, physical and family environment',
  'T1030': 'Nursing care, in the home, by RN, per diem',
  'T1031': 'Nursing care, in the home, by LPN, per diem',
  'T2002': 'Non-emergency transportation, per trip',
  'T2003': 'Non-emergency transportation, encounter/trip',
  'T2005': 'Non-emergency transportation, stretcher van',
  'T2007': 'Transportation waiting time, air ambulance/rotary wing',
  'T2013': 'Habilitation, education, waiver, per diem',
  'T2017': 'Habilitation, residential, waiver, 15 min',
  'T2019': 'Habilitation, supported employment, per 15 min',
  'T2020': 'Day habilitation, waiver, per diem',
  'T2022': 'Case management, per month',
  'T2023': 'Day habilitation, waiver, per 15 min (non-Medicaid)',
  'T2025': 'Waiver services, NOS',
  'T2028': 'Specialized supply, NOS, waiver',
  'T2029': 'Specialized medical equipment, NOS, waiver',
  'T2034': 'Crisis intervention, per 15 min',
  'T2036': 'Therapeutic camping, waiver, per diem',
  'T2038': 'Community transition, waiver, per service',
  'T2041': 'Supports brokerage, waiver, per 15 min',
  'T2042': 'Hospice routine home care, per diem',
  // S codes
  'S5100': 'Day care services, adult, per 15 min',
  'S5101': 'Day care services, adult, per half day',
  'S5102': 'Day care services, adult, per diem',
  'S5105': 'Day care services, center-based, per 15 min',
  'S5108': 'Home care training, home health aide, per session',
  'S5109': 'Home care training, home health aide, per 15 min',
  'S5110': 'Home care training, family member, per 15 min',
  'S5111': 'Home care training, family member, per session',
  'S5115': 'Home modifications, per service',
  'S5120': 'Chore services, per 15 min',
  'S5121': 'Companion services, adult, per 15 min',
  'S5126': 'Attendant care services, per diem',
  'S5130': 'Homemaker service, NOS, per 15 min',
  'S5131': 'Homemaker service, NOS, per diem',
  'S5135': 'Companion services, adult, per diem',
  'S5140': 'Foster care, adult, per diem',
  'S5145': 'Foster care, adult, per month',
  'S5150': 'Unskilled respite care, per 15 min',
  'S5151': 'Unskilled respite care, per diem',
  'S5160': 'Emergency response system, per month',
  'S5165': 'Home modifications, per service (see also S5115)',
  'S5170': 'Home delivered meals, per meal',
  'S5175': 'Laundry service, per occasion',
  'S5180': 'Home health respiratory therapy, per visit',
  'S5181': 'Home health training, per visit',
  'S5185': 'Medication reminder service, NOS, per month',
  'S5190': 'Wellness assessment, performed by non-physician',
  'S5199': 'Personal care item, NOS, each',
  'S9083': 'Global fee urgent care centers',
  'S9088': 'Services provided in an urgent care center',
  'S9097': 'Home visit for wound care',
  'S9123': 'Nursing care, in the home; by RN, per hour',
  'S9124': 'Nursing care, in the home; by LPN, per hour',
  'S9125': 'Respite care, in the home, per diem',
  'S9126': 'Hospice care, in the home, per diem',
  'S9127': 'Social work visit, in the home, per diem',
  'S9128': 'Speech therapy, in the home, per diem',
  'S9129': 'OT, in the home, per diem',
  'S9131': 'PT, in the home, per diem',
  'S9152': 'Speech therapy, re-evaluation',
  // G codes (CMS-specific)
  'G0101': 'Cervical/vaginal cancer screening; pelvic exam',
  'G0102': 'Prostate cancer screening; digital rectal exam',
  'G0108': 'Diabetes self-management training, individual',
  'G0109': 'Diabetes self-management training, group',
  'G0120': 'Colorectal cancer screening; barium enema',
  'G0121': 'Colorectal cancer screening; colonoscopy',
  'G0127': 'Trimming of dystrophic nails, any number',
  'G0151': 'Services of PT in home health, per 15 min',
  'G0152': 'Services of OT in home health, per 15 min',
  'G0153': 'Services of SLP in home health, per 15 min',
  'G0154': 'Services of skilled nurse in home health, per 15 min',
  'G0155': 'Services of clinical social worker in home health, per 15 min',
  'G0156': 'Services of home health aide in home health, per 15 min',
  'G0157': 'Services of PT assistant in home health, per 15 min',
  'G0158': 'Services of OT assistant in home health, per 15 min',
  'G0159': 'Services of clinical social worker in home health, per 15 min',
  'G0162': 'Skilled services by RN in home health, per 15 min',
  'G0176': 'Activity therapy (group), per session',
  'G0177': 'Training and educational services, per session',
  'G0270': 'Medical nutrition therapy, reassessment, individual',
  'G0299': 'Direct skilled nursing services of RN in home health',
  'G0300': 'Direct skilled nursing services of LPN in home health',
  'G0378': 'Hospital observation per hour',
  'G0379': 'Direct admission to hospital observation',
  'G0402': 'Initial preventive physical exam (Welcome to Medicare)',
  'G0438': 'Annual wellness visit, first visit',
  'G0439': 'Annual wellness visit, subsequent visit',
  'G0463': 'Hospital outpatient clinic visit',
  'G0483': 'Drug test, definitive, utilizing drug identification methods',
  'G0490': 'Face-to-face home health nursing visit by RN',
  'G0495': 'Skilled services of LPN in home health',
  'G0506': 'Comprehensive assessment of chronic care management',
  'G0511': 'RHC/FQHC visit, psychiatric collaborative care model',
  'G2010': 'Remote evaluation of patient video/images',
  'G2012': 'Brief communication technology-based service',
  'G2021': 'Health care common procedure coding system HCPCS lvl II',
  'G2023': 'Specimen collection for COVID-19 testing',
  'G9005': 'Coordinated care fee, risk-adjusted, ESRD',
  // Q codes
  'Q5001': 'Hospice/home health aide, per visit',
  'Q5009': 'Hospice/home health aide, per 15 min',
  // Surgical/procedure
  '92523': 'Evaluation of speech sound production',
  '92507': 'Treatment of speech/language/voice disorder',
  '92521': 'Evaluation of speech fluency',
  '92522': 'Evaluation of speech sound production',
  '92524': 'Behavioral/qualitative analysis of voice',
  '92526': 'Treatment of swallowing dysfunction',
  '96110': 'Developmental screening',
  '96112': 'Developmental test administration',
  '96113': 'Developmental test admin, each additional 30 min',
  '96127': 'Brief emotional/behavioral assessment',
  '96130': 'Psychological testing evaluation, first hour',
  '96131': 'Psychological testing evaluation, each additional hour',
  '96136': 'Psychological/neuropsychological testing, first 30 min',
  '96137': 'Psychological/neuropsychological testing, each additional 30 min',
  '96150': 'Health behavior assessment, initial',
  '96151': 'Health behavior reassessment',
  '96152': 'Health behavior intervention, individual',
  '96153': 'Health behavior intervention, group',
  '96160': 'Patient-focused health risk assessment',
  '99199': 'Unlisted special service, procedure or report',
  '99499': 'Unlisted evaluation and management service',
  // Drug admin
  'J2326': 'Nusinersen (Spinraza) injection',
  'J1745': 'Infliximab injection',
  'J3490': 'Unclassified drugs',
  'J7030': 'Normal saline solution infusion, 1000 cc',
  'J7040': 'Normal saline solution infusion, 500 cc',
  'J7050': 'Normal saline solution infusion, 250 cc',
  'J7120': 'Ringer\'s lactate infusion, up to 1000 cc',
  // Telehealth
  '99441': 'Telephone E/M by physician, 5-10 min',
  '99442': 'Telephone E/M by physician, 11-20 min',
  '99443': 'Telephone E/M by physician, 21-30 min',
  '99421': 'Online digital E/M, 5-10 min',
  '99422': 'Online digital E/M, 11-20 min',
  '99423': 'Online digital E/M, 21+ min',
};

for (const [code, desc] of Object.entries(commonCodes)) {
  if (!descriptions[code]) descriptions[code] = desc;
}
console.log('After common codes:', Object.keys(descriptions).length);

// Write output
const outPath = path.join(__dirname, '..', 'public', 'data', 'code-descriptions.json');
fs.writeFileSync(outPath, JSON.stringify(descriptions, null, 2));
console.log('Wrote', Object.keys(descriptions).length, 'descriptions to', outPath);
